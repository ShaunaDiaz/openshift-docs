//Module included in the following assemblies:
//
//* microshift_running_apps/microshift-operators-olm.adoc

:_mod-docs-content-type: PROCEDURE
[id="microshift-oc-mirror-embed-ops-disconnected-use_{context}"]
= Using catalog and Operator images with RHEL for Edge in disconnected environments

To use Operators in a {op-system-ostree-first} image, use the oc-mirror plugin in dry-run mode to produce the filtered catalog index. After the dry run, you must parse the index, get all the image references, and format the output for adding to an Image Builder blueprint.

[NOTE]
====
For catalogs made for proprietary Operators, you can format image references for the Image Builder blueprint without using the following procedure.
====

.Prerequisites
* You have a catalog index for the Operators you want to use.
* You have installed the `jq` CLI tool.
* You are familiar with Image Builder blueprint files.
* You have an Image Builder blueprint TOML file. If you have not created one, you can use the blueprint installed in the `/usr/share/microshift/blueprint` directory that is specific to your platform architecture.

.Procedure

. Parse the catalog index and get the image references by running the following example command:
+
[source,terminal]
----
jq -r --slurp '.[] | select(.relatedImages != null) | "[[containers]]\nsource = \"" + .relatedImages[].image + "\"\n"'   ./oc-mirror-workspace/src/catalogs/registry.redhat.io/redhat/redhat-operator-index/v4.15/index/index.json
----

. Optional: Filter out images that cannot be mirrored by running the following command:
+
[source,terminal]
----
$ jq -r --slurp '.[] | select(.relatedImages != null) | .relatedImages[] | select(.name |  contains("ppc") or contains("s390x") | not) | "[[containers]]\\nsource = \\"" + .image + "\\"\\n"' ./oc-mirror-workspace/src/catalogs/registry.redhat.io/redhat/redhat-operator-index/v4.15/index/index.json
----
+
[NOTE]
====
This optional step uses the AMQ Broker Operator as an example. You can add other criteria to the `jq` command for further filtering as required by your use case.
====
+
.Example output
[source,terminal]
----
[[containers]]
source = "registry.redhat.io/amq7/amq-broker-init-rhel8@sha256:0b2126cfb6054fdf428c1f43b69e36e93a09a49ce15350e9273c98cc08c6598b"

[[containers]]
source = "registry.redhat.io/amq7/amq-broker-init-rhel8@sha256:0dde839c2dce7cb684094bf26523c8e16677de03149a0fff468b8c3f106e1f4f"
...
...

[[containers]]
source = "registry.redhat.io/amq7/amq-broker-rhel8@sha256:e8fa2a00e576ecb95561ffbdbf87b1c82d479c8791ab2c6ce741dd0d0b496d15"

[[containers]]
source = "registry.redhat.io/amq7/amq-broker-rhel8@sha256:ff6fefad518a6c997d4c5a6e475ba89640260167f0bc27715daf3cc30116fad1"
…
EOF
----
+
[IMPORTANT]
====
For mirrored and disconnected cases, ensure that all of the sources filtered from your Operator's `index.json` file are digests. If any of the sources use tags instead of digests, the Operator installation fails.
====

. Get the SHA of the catalog index image by running the following command:
+
[source,terminal]
----
$ skopeo inspect docker://registry.example.com/redhat/redhat-operator-index:v4.15 | jq `.Digest` <1>
----

+
.Example output
[source,terminal]
----
"sha256:7a76c0880a839035eb6e896d54ebd63668bb37b82040692141ba39ab4c539bc6"
----

//. View the `imageset-config.yaml` to get the Operator image reference by running the following command:
//+
//[source,terminal]
//----
//$ cat imageset-config.yaml
//----
//+
//.Example output
//[source,terminal]
//----
//kind: ImageSetConfiguration
//apiVersion: mirror.openshift.io/v1alpha2
//storageConfig:
//  registry:
//    imageURL: registry.example.com/microshift-mirror
//mirror:
//  operators:
//  - catalog: registry.redhat.io/redhat/redhat-operator-index:v4.15 <1>
//    packages:
//    - name: amq-broker-rhel8
//      channels:
//      - name: 7.11.x
//----
//<1> Use the value in the `mirror.catalog` field as the catalog image reference for the blueprint.

. To get ready to add the image references to your Image Builder blueprint file, format the catalog image reference by using the following example:
+
[source,terminal]
----
[[containers]]
source = "registry.example.com/redhat/redhat-operator-index@sha256:7a76c0880a839035eb6e896d54ebd63668bb37b82040692141ba39ab4c539bc6"
----

. Add the image references from all the previous steps to the Image Builder blueprint.
+
.Generated Image Builder blueprint example snippet
[source,text]
----
name = "microshift_blueprint"
description = "MicroShift 4.15.1 on x86_64 platform"
version = "0.0.1"
modules = []
groups = []

[[packages]] <1>
name = "microshift"
version = "4.15.1"
...
...

[customizations.services] <2>
enabled = ["microshift"]

[customizations.firewall]
ports = ["22:tcp", "80:tcp", "443:tcp", "5353:udp", "6443:tcp", "30000-32767:tcp", "30000-32767:udp"]
...
...

[[containers]] <3>
source = "quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f41e79c17e8b41f1b0a5a32c3e2dd7cd15b8274554d3f1ba12b2598a347475f4"

[[containers]]
source = "quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:dbc65f1fba7d92b36cf7514cd130fe83a9bd211005ddb23a8dc479e0eea645fd"
...
...

[[containers]] <4>
source = "registry.example.com/redhat/redhat-operator-index@sha256:7a76c0880a839035eb6e896d54ebd63668bb37b82040692141ba39ab4c539bc6"
...
...

[[containers]] <5>
source = "registry.redhat.io/amq7/amq-broker-init-rhel8@sha256:0b2126cfb6054fdf428c1f43b69e36e93a09a49ce15350e9273c98cc08c6598b"

[[containers]]
source = "registry.redhat.io/amq7/amq-broker-init-rhel8@sha256:0dde839c2dce7cb684094bf26523c8e16677de03149a0fff468b8c3f106e1f4f"
...
...

[[containers]]
source = "registry.redhat.io/amq7/amq-broker-rhel8@sha256:e8fa2a00e576ecb95561ffbdbf87b1c82d479c8791ab2c6ce741dd0d0b496d15"

[[containers]]
source = "registry.redhat.io/amq7/amq-broker-rhel8@sha256:ff6fefad518a6c997d4c5a6e475ba89640260167f0bc27715daf3cc30116fad1"
…
EOF
----
<1> References for all non-optional {microshift-short} RPM packages using the same version compatible with the `microshift-release-info` RPM.
<2> References for automatically enabling {microshift-short} on system startup and applying default networking settings.
<3> References for all non-optional {microshift-short} container images necessary for an offline deployment.
<4> References for the catalog index.
<5> References for Operator images.

.Next steps
* Create a disconnected {op-system-ostree} image.
* Configure networking for disconnected use.
* Configure settings for Operator use.
* Create and apply Catalog Source and Subscription custom resources.
