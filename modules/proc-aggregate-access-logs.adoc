// Module included in the following assemblies:
//
// *observability/observability.adoc

:_mod-docs-content-type: PROCEDURE
[id="ref-obs-aggregate-access-logs_{context}"]
= Aggregating access logs with Loki

[role="_abstract"]
You can aggregate your Envoy access logs into a set of data that you can interact with to find issue causes, query, and scale. You can even create post-event metrics where by using the `LogQL` function to count occurrences of specific IP address ranges in your access logs and graph them in a dashboard.

.Prerequisites

* You installed {prodname}.
* You have a running {ocp} cluster.
* You have administrator access to the {ocp} cluster.
* You enabled access logs.
* You are using Red Hat OpenShift Logging.
* You are using the Loki Operator.

.Procedure
//Promtail as shown upstream is deprecated by Grafana (is it supportable by OpenShift support? i am not sure). Can we use Vector downstream? Seems to be preferred in OpenShift.
. Use the `ClusterLogForwarder` to define your aggregation pipelines, as shown in the following example:
+
[source,yaml]
----
spec:
  outputs:
    - name: central-loki
      type: loki
      url: https://loki.internal:3100
  pipelines:
    - name: aggregate-all-apps
      inputRefs:
        - application
        - audit
      outputRefs:
        - central-loki
      filterRefs:
        - parse-json # A custom filter to unify formats
----

. Optional: Configure Promtail to aggregate logs as shown in the following example:
+
[source,yaml]
----
apiVersion: v1
kind: ConfigMap
metadata:
  name: promtail-config
  namespace: monitoring
data:
  promtail.yaml: |
    server:
      http_listen_port: 9080
      grpc_listen_port: 0

    positions:
      filename: /tmp/positions.yaml

    clients:
      - url: http://loki.monitoring.svc.cluster.local:3100/loki/api/v1/push

    scrape_configs:
      - job_name: kubernetes-pods
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            target_label: app
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
        pipeline_stages:
          - json:
              expressions:
                request_id: request_id
                level: level
                timestamp: start_time
          - labels:
              request_id:
              level:
----
